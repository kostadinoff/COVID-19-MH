---
title: "Анализ на регистрираните COVID-19 случаи"
author: "Кеворкян К., Райчева Р.Костадинов К."
date: "24/03/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

library(fifer)

```{r pakeges, include=FALSE}
library(tidyverse)
library(easystats)
library(tayloRswift)
library(readr)
library(officer)
library(janitor)
library(flextable)
library(apyramid)
library(rstatix)
library(gtsummary)
library(arsenal)
library(gt)
library(emmeans)
library(chisq.posthoc.test)
Sys.setlocale(locale = "Bulgarian")
```

# Сравнителен анализ на оздравели и починали.

В предоставената базата данни, за периода са осъществени 247 441 хоспитализиции. Общо хоспитализираните са 22% от всички регистрирани инфектирани. По-висок относителен дял на хоспитализираните се наблюдава при мъжете 50,7% спрямо жените 49,3%. По отношение на възрастовото разпределение : средната възраст при нехоспитализираните е 43,9 (SD = 18.0), докато при приетите в болница 62,2 (SD = 16.9), като разликата във възрастта е статистически значима (p<0.001)

```{r read_data, include=FALSE}
cov = read_csv("C:\\\\Users\\PC\\Desktop\\covid_full.csv", 
    col_types = cols(exam_date = col_date(format = "%d.%m.%Y"), 
         lastvac_date = col_date(format = "%d.%m.%Y"), 
         start_hospis = col_date(format = "%d.%m.%Y"), 
         end_hospis = col_date(format = "%d.%m.%Y")))
cov = as_tibble(cov)

dth <- read_csv("https://raw.githubusercontent.com/kostadinoff/COVID-19-MH/master/data/COVID_MH_data/deaths.csv", col_types = cols(add_day = col_date(format = "%Y-%m-%d"), 
    death_day = col_date(format = "%Y-%m-%d")))
dth = as_tibble(dth)
```


```{r data_prepare, include=FALSE}
cov = cov %>% 
  mutate(status = if_else(is.na(outcome_covid), "R", "D")) %>% 
  mutate(hospital_treat = ifelse(is.na(start_hospis), "Home", "Hospital")) %>% 
  mutate(wave = case_when(exam_date <='2021-07-07'~ "alpha",
                          exam_date > '2021-07-07' & exam_date <= '2022-01-26' ~ "delta",
                          exam_date > '2022-01-26'~ "omicron")) %>% 
  mutate(time_to_event = case_when(hospital_treat == "Hospital" ~difftime(start_hospis, exam_date, units = "days"),
                                       
                                   hospital_treat == "Home" ~ 0)) %>%
  mutate(time_in_hospital = case_when(hospital_treat == "Hospital" ~difftime(end_hospis, start_hospis, units = "days"),
                                       
                                   hospital_treat == "Home" ~ 0)) %>%
  mutate(time_to_event = as.numeric(time_to_event)) %>% 
  mutate(time_in_hospital = as.numeric(time_in_hospital)) %>% 
  mutate(vax_status = if_else(is.na(vaccine_name), "No_vax", "Vax")) %>% 
  mutate(vac_status = case_when(vax_status == "Vax" & lastvac_date < exam_date ~ "Vax",
                                TRUE ~ "No_vax")) %>% 
  dplyr::select(-vax_status) %>% 
  mutate(time_after_vax = case_when(vac_status == "Vax" ~ difftime(exam_date,lastvac_date, units = "days"),
                                       
                                   vac_status == "No_vax"  ~ 0)) %>% 
  mutate(time_after_vax = as.numeric(time_after_vax)) 
  
cov$time_to_event <- replace(cov$time_to_event, cov$time_to_event <= 0 & cov$hospital_treat == "Home" , NA)      
cov$time_to_event <- replace(cov$time_to_event, cov$time_to_event < 0, NA) 
cov$time_after_vax <- replace(cov$time_after_vax, cov$time_after_vax < 0, NA)      
cov$time_in_hospital <- replace(cov$time_in_hospital, cov$time_in_hospital <= 0, NA) 
cov["age_group"] = cut(cov$age, c(0, 14, 24,34, 44, 54, 64, 74, 84, 94, Inf), 
                       c("0-14","15-24","25-34","35-44","45-54","55-64",
                         "65-74","75-84","85-94","> 95"), include.lowest=TRUE)

```


Наблюдава се и статистически значима асоциация между вариантите (определени по датата с съобщени от НЦЗПЗ с над 50% преобладаващ вариант в иследваните проби) и относителният дял на хоспитализираните. В началото на пандемията С преобладаващият алфа вариант са реализирани над 50% от всички хоспитализации за периода. Разгледано стратифицирано за вариат алфа относителният дял на хоспитализираните е 30%, който статистически значимо по-висок от този при вариант делта (19%) и вариант омикрон (12%). Редно е да се отбележи, че това от части се дължи на законови изисквания за задължителното изолиране в болница, а не само поради състояние налагащо това.

Наблюдава се и статистически значима разлика в възрастовата структура на инфектираните. При вариант алфа средната възраст на инфектираните е 51 г. което е е с 6 години повече от средната възраст при вариант делта и омикрон. (? вероятно заради селективното тестване в периода).

С началото на ваксинационната кампания, се установят и значими различия между относителнителните дялове на ваксинираните инфектирани, като най-висок е дела на ваксинираните сред инфектираните в рамките на вълната на омикрон варианта. 

```{r wave_characteristics, echo=FALSE}
hospitalis_all = cov %>% 
  dplyr::select(vac_status,status,wave,gender, age, hospital_treat) %>% 
  mutate(male = ifelse(gender=="M",1,0)) %>% 
  mutate(hospitalized = ifelse(hospital_treat=="Hospital",1,0)) %>% 
  mutate(vacinated = ifelse(vac_status =="Vax",1,0)) %>% 
  mutate(case_fatality = ifelse(status == "R",0,1)) %>% 
  dplyr::select(age,wave,male,hospitalized,vacinated,case_fatality ) %>% 
  tbl_summary(
    by = wave,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)")) %>% 
  add_p() %>% 
  as_flex_table()
  
hospitalis
```


Разгледано в групата на преболедувалите, средната възраст в периода на алфа варианта (51) е с 6,5 (95% CI 6.32-6.51, p<0.001) години по-висока от тази при делта варинат (44,48), , p<0.001) и с 5 (95% CI 4.79-5.03, p<0.001) години по-висока от тази в периода на вариант омикрон (х= 45,91)

```{r wave_characteristics_1, echo=FALSE}
hospitalis_R = cov %>%
  filter(status== "R") %>% 
  dplyr::select(vac_status,wave,gender, age, hospital_treat) %>% 
  mutate(male = ifelse(gender=="M",1,0)) %>% 
  mutate(hospitalized = ifelse(hospital_treat=="Hospital",1,0)) %>% 
  mutate(vacinated = ifelse(vac_status =="Vax",1,0)) %>% 
  dplyr::select(age,wave,male,hospitalized,vacinated) %>% 
  tbl_summary(
    by = wave,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)")) %>% 
  add_p() %>% 
  as_flex_table()
  
hospitalis_R
```

Различна е ситуацията по отношение на леталитета. В периода на разпространение на делта варианта се наблюдава и най-високият дял на починалите - 62% от всички починали в предоставените данни.  Не се наблюдава статистически значима разлика във възрастта при починалите по време на алфа и делта вариант (p = 0,988), омикрон се характеризира с по-висока средна възраст сред групата на починалите (x = 75,5 +/-10,8) (? еми хем е по-малко летален хем и ваксини има все пак). По отношение на половото съотношение: за групата на починалите най-ниско полово съотношение мъже:жени (1.06) се установява при делта варианта, докато алфа и омикрон се характеризират със статистически значимо по-висок леталитет при мъжкия пол (полово съотношение за алфа вариант: 1,32 и за омикрон: 1,31). Като цяло делта вариант, се характеризира и с  най-висок леталитет (4,1%), което е с 2% по-висок от този при алфа варианта и 2,5% по висок от варианта омикрон.



```{r wave_characteristics_2, echo=FALSE}
hospitalis_D = cov %>%
  filter(status== "D") %>% 
  dplyr::select(vac_status,wave,gender, age, hospital_treat) %>% 
  mutate(male = ifelse(gender=="M",1,0)) %>% 
  mutate(hospitalized = ifelse(hospital_treat=="Hospital",1,0)) %>% 
  mutate(vacinated = ifelse(vac_status =="Vax",1,0)) %>% 
  dplyr::select(age,wave,male,hospitalized,vacinated) %>% 
  tbl_summary(
    by = wave,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)")) %>% 
  add_p() %>% 
  as_flex_table()
  
hospitalis_D
```





По отношение на разпределение по области се наблюдава статистическа значима асоцация между областта и относителния дял на хоспитализираните, като най-висок се наблюдава в област Смолян (40,9%), а най-нисък в област София (столица) 12,6 %


```{r include=FALSE}
cov = cov %>% 
  mutate(comp_outcome = case_when(hospital_treat == "Home" ~ "Recovery",
                                  status == "D" ~ "Death",
                                  TRUE ~ "Hospitalized"))
```

По отношение на областното разпределение в таблицата по-долу е представена информация за разликата между относителните дялове на ваксинираните и неваксинираните сред починалите и хоспитализираните. Най-висока разлика по отношение на хоспитализициятата се наблюдава в област Смолян, където хоспитализираните неваксинирани са с 18,6 процентни повече спрямо ваксинираните. За област монтана ваксинацията е довела до 2,2 процента спад в леталитеа.  Най-малък ефект върху леталитета се наблюдава за област Благоевград, а по-отношение на хоспитализацията в област София (столица). 

```{r diference, echo=FALSE}
province_v = cov %>% 
  filter(vac_status == "Vax") %>% 
  freq_table(province,comp_outcome) %>% 
  rename(n_vacinated = n,
         prop_vacinated = prop)

province_nv = cov %>% 
  filter(vac_status == "No_vax") %>% 
  freq_table(province,comp_outcome) %>% 
    rename(non_vax_n = n,
         non_vac_prop = prop)

province_all = province_v %>% 
  inner_join(province_nv) %>% 
  mutate(dif_vax_nonvax = (non_vac_prop-prop_vacinated)) %>% 
  select(province, comp_outcome,dif_vax_nonvax) %>% 
  pivot_wider(names_from = comp_outcome, values_from = dif_vax_nonvax) %>% 
  select(-Recovery) %>% 
  rename(case_fatality_dif= Death, 
         hospitalisation_dif = Hospitalized) %>% 
  flextable()
province_all
```

По отношение на времето от заразяването до постъпване в болница и продължителността на хоспитализацията  и се установяват статистически значими разлики. В групата на починалите и преболедувалите. Средното време между позитивния резултат и хоспитализацията при починалите е 5,3 дни, докато при преболедувалите 8,0 дни (разлика 2,7 дни). За периода на хоспитализацията - статистически значимо по-висок при преболедувалите (11,2 дни), спрямо починалите (10.5)
```{r timing_days, echo=FALSE}
timing = cov %>% 
  filter(hospital_treat == "Hospital") %>% 
  select(status,time_to_event, time_in_hospital) %>% 
  tbl_summary(by = status,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"),
              missing="no") %>% 
  add_difference() %>% 
  as_flex_table()
timing
```

Стратифицирано за ваксинирани -  няма статистически значима разлика в периода на хоспитализация и времето от позитивния тест до хоспитализацията. 

```{r timing_days_vax, echo=FALSE}
timing_vax = cov %>% 
  filter(hospital_treat == "Hospital") %>% 
  filter(vac_status == "Vax") %>% 
  select(status,time_to_event, time_in_hospital) %>% 
  tbl_summary(by = status,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"),
              missing="no") %>% 
  add_difference() %>% 
  as_flex_table()
timing_vax
```

За групата на неваксинираните се наблюдават отчетливи разлики 
1. между времето от позитивиране на теста до хоспитализация (2,8 дни повече за преполедувалите) 
2. Времетраенето на самата хоспитализация (0,82 дни повече за преболедувалите) в групите на починалите и преболедувалите

```{r timing_days_nvax, echo=FALSE}
timing_nvax = cov %>% 
  filter(hospital_treat == "Hospital") %>% 
  filter(vac_status == "No_vax") %>% 
  select(status,time_to_event, time_in_hospital) %>% 
  tbl_summary(by = status,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} / {N} ({p}%)"),
              missing="no") %>% 
  add_difference() %>% 
  as_flex_table()
timing_nvax
```

Друга важна характеристика зависимостта между леталитета и времето от последната поставена доза ваксина. Ваксинираните инфектирани пациенти се разделиха на две групи - последната поставена доза до 1 месец преди инфектиране и доза поставена преди повече от 1 месец. Разликата в леталитета на двете групи е 1,7% (...обяснения за времето нужно за създадване на имуните и т.н.)
Времето от последната поставена доза е и сигнификатно значим фактор асоцииран с риска за смърт при инфектираните (HR =0.997, 95% CI 0.997-0.99)

```{r}
vacine_letal = 
  cov %>% 
  filter(vac_status == "Vax") %>% 
  select(status, time_after_vax) %>% 
  mutate(time_after_vac = ifelse(time_after_vax %in% 0:30, "Up to 1mo", "More than 1mo"),
         case_fatality = ifelse(status=="D",1,0)) %>% 
  select(time_after_vac,case_fatality) %>% 
  tbl_summary(
    by = time_after_vac
  ) %>% 
  add_difference() %>% 
  flextable()

vacine_letal
```



# Изграждане на модел за леталитета. 

В основа на описаните характеристики се 





```{r}
vax_status = cov %>% 
  mutate(vaccinated = if_else(is.na(vaccine_name), 0, 1)) %>% 
  select(vaccinated, status) %>% 
  tbl_summary(by = status, # split table by group
             statistic = list(
        all_continuous() ~ "{mean} ({sd})",
        all_dichotomous() ~ "{p}%"),
    missing = "no") %>%
  add_n() %>% # add column with total number of non-missing observations
            add_difference() %>% 
            as_flex_table()
vax_status

```

```{r}
vax_status_real = cov %>% 
  filter(exam_date >'2021-01-01') %>% 
  mutate(vaccinated = if_else(is.na(vaccine_name), 0, 1)) %>% 
  select(vaccinated, status) %>% 
  tbl_summary(by = status, # split table by group
             statistic = list(all_dichotomous() ~ "{p}%"),
            missing = "no") %>%
  add_n() %>% # add column with total number of non-missing observations
            add_difference() %>% 
            as_flex_table()
vax_status_real
  
```

```{r}

vax_status_full = cov %>% 
  filter(exam_date >'2021-03-01') %>% 
  select(status,is_f_vac) %>% 
  tbl_summary(by = status, # split table by group
             statistic = list(all_dichotomous() ~ "{p}%"),
             missing = "no") %>%
  add_n() %>% # add column with total number of non-missing observations
            add_difference() %>% 
            as_flex_table()
vax_status_full
```

```{r}

cov_r = cov %>% 
  mutate(death = ifelse(status == "D", 1, 0)) %>% 
  select(death, province, is_f_vac)
reg <- glm(death ~ is_f_vac+province, data=cov_r, family=binomial)

```

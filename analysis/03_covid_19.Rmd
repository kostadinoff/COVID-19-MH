---
title: "Анализ на регистрираните COVID-19 случаи"
author: "Кеворкян К., Райчева Р.Костадинов К."
date: "24/03/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r pakeges, include=FALSE}
library(tidyverse)
library(easystats)
library(tayloRswift)
library(readr)
library(officer)
library(janitor)
library(flextable)
library(apyramid)
library(rstatix)
library(gtsummary)
library(hrbrthemes)
Sys.setlocale(locale = "Bulgarian")
```



```{r read_data, include=FALSE}
cov = read_csv("C:\\\\Users\\PC\\Desktop\\covid_full.csv", 
    col_types = cols(exam_date = col_date(format = "%d.%m.%Y"), 
         lastvac_date = col_date(format = "%d.%m.%Y"), 
         start_hospis = col_date(format = "%d.%m.%Y"), 
         end_hospis = col_date(format = "%d.%m.%Y")))
cov = as_tibble(cov)
```

```{r data_prepare, include=FALSE}
cov = cov %>% 
  mutate(status = if_else(is.na(outcome_covid), "R", "D")) %>% 
  mutate(hospital_treat = ifelse(is.na(start_hospis), "Home", "Hospital")) %>% 
  mutate(wave = case_when(exam_date <='2021-07-07'~ "alpha",
                          exam_date > '2021-07-07' & exam_date <= '2022-01-26' ~ "delta",
                          exam_date > '2022-01-26'~ "omicron")) %>% 
  mutate(time_test_hospital = case_when(hospital_treat == "Hospital" ~difftime(start_hospis, exam_date, units = "days"),
                                       
                                   hospital_treat == "Home" ~ 0)) %>%
  mutate(time_in_hospital = case_when(hospital_treat == "Hospital" ~difftime(end_hospis, start_hospis, units = "days"),
                                       
                                   hospital_treat == "Home" ~ 0)) %>%
  mutate(time_test_hospital = as.numeric(time_test_hospital)) %>% 
  mutate(time_in_hospital = as.numeric(time_in_hospital)) %>% 
  mutate(vax_status = if_else(is.na(vaccine_name), "No_vax", "Vax")) %>% 
  mutate(vac_status = case_when(vax_status == "Vax" & lastvac_date < exam_date ~ "Vax",
                                TRUE ~ "No_vax")) %>% 
  dplyr::select(-vax_status) %>% 
  mutate(time_after_vax = case_when(vac_status == "Vax" ~ difftime(exam_date,lastvac_date, units = "days"),
                                       
                                   vac_status == "No_vax"  ~ 0)) %>% 
  mutate(time_after_vax = as.numeric(time_after_vax)) %>% 
  mutate(month = format(exam_date, "%m"), year = format(exam_date, "%Y")) 
```


```{r data_prepare, include=FALSE}
cov$time_to_event <- replace(cov$time_to_event, cov$time_to_event <= 0 & cov$hospital_treat == "Home" , NA)      
cov$time_to_event <- replace(cov$time_to_event, cov$time_to_event < 0, NA) 
cov$time_after_vax <- replace(cov$time_after_vax, cov$time_after_vax < 0, NA)      
cov$time_in_hospital <- replace(cov$time_in_hospital, cov$time_in_hospital <= 0, NA) 
cov["age_group"] = cut(cov$age, c(0, 14, 24,34, 44, 54, 64, 74, 84, 94, Inf), 
                       c("0-14","15-24","25-34","35-44","45-54","55-64",
                         "65-74","75-84","85-94","> 95"), include.lowest=TRUE)

```

```{r read_data, include=FALSE}
rhi = read_csv("C:\\\\Users\\PC\\Desktop\\rhi_m.csv",
    col_types = cols(date = col_date(format = "%d/%m/%Y")))
rhi = rhi %>% 
  as_tibble() %>% 
  mutate(month = format(date, "%m"), year = format(date, "%Y")) %>% 
  rename( province = region )
```

```{r read_data, include=FALSE}
rhi_due = read_csv("C:\\\\Users\\PC\\Desktop\\rhi_y.csv",
   col_types = cols(year = col_character()))
```

```{r read_data, include=FALSE}
population = read_csv("C:\\\\Users\\PC\\Desktop\\population.csv")
population = population %>% 
  rename("2022" = "av_p") %>% 
  pivot_longer(cols = 3:5, names_to = "year", values_to = "population") %>% 
  rename(province = region)
```

```{r read_data, include=FALSE}
cov_pivot = cov %>% 
  group_by(province, month, year) %>% 
  summarise(n = n())
```

```{r read_data, include=FALSE}
jt = cov_pivot %>% 
  left_join(population) %>% 
  left_join(rhi_due)
```

```{r read_data, include=FALSE}
cov  = cov %>% 
  left_join(jt)
```

```{r read_data, include=FALSE}
doses_dates <- read_csv("C:/Users/PC/Desktop/doses_dates.csv", 
     col_types = cols(date = col_datetime(format = "%d/%m/%Y %H:%M"), 
         ...3 = col_skip()))
doses_dates = doses_dates %>% 
  mutate(month = format(date, "%m"), year = format(date, "%Y")) %>% 
  rename(province = region) %>% 
  select(-date)
```

```{r read_data, include=FALSE}
doses_types <- read.csv("C:/Users/PC/Desktop/doses_types.csv", encoding="UTF-8", stringsAsFactors=TRUE)
doses_types = as_tibble(doses_types)
```


```{r read_data, include=FALSE}
cov_j = cov %>% 
  group_by(province, month, year, status) %>% 
  summarise(n= n()) %>% 
  pivot_wider(names_from = status, values_from = n) %>% 
  mutate_if(is.integer, ~replace(., is.na(.), 0)) %>% 
  mutate(case_fatality = (D / (D+R)*100)) %>% 
  left_join(doses_dates) %>% 
  select(-c(R, D)) %>% 
  mutate(doses = if_else(is.na(doses), 0, doses)) %>% 
  left_join(population) %>% 
  select(-region_id) %>% 
  mutate(doses_per_capita = (doses/population)*100) %>% 
  select(-c(population, doses)) %>% 
  select(case_fatality, doses_per_capita)
```

```{r read_data, include=FALSE}
cov_j %>% 
  group_by(province) %>% 
  summarise(case_fatality = mean(case_fatality),
            doses_per_capita = mean(doses_per_capita)) %>% 
  ungroup() %>% 
  select(case_fatality, doses_per_capita) %>% 
  correlation()
```

# Общо поставени васкини (брой и вид поставени ваксини; във времето по 
вид ваксина; по области, по места на поставяне на ваксината/пунтове за поставяне)

```{r read_data, include=FALSE}
doses_shots <- read_csv("C:/Users/PC/Desktop/doses_shots.csv",
         col_types = cols(...2 = col_skip())) %>% 
  pivot_longer(col = 2:12, names_to = "type", values_to = "n")

```

В предоставената информация по отношение на ваксинациите се установява 
общ брой поставени ваксини от: 4331511. При разглеждане на процентното разпределение
по време на поставяне на дозите се очертават 2 своеобразни "пика" във ваксинацията. 
Първия през месец април на 2021г (през който са поставени над 12% от всички дози)
Вторият пик на ваксинацията е през месеците октомври - декември на същата година. 
С началото на 2022 г. се наблюдава и сериозен спад във имунизационната кампания, 
като средно за страната в този период са поставени едва под 2% от всички дози. 
```{r echo=FALSE}
doses_dates = doses_dates %>% 
  mutate(day = "01")
doses_dates$date<-as.Date(with(doses_dates,paste(year,month,day,sep="-")),
                          "%Y-%m-%d")
doses_dates$date <- ymd(doses_dates$date)

  figure_1 = doses_dates %>% 
  group_by(province) %>% 
  select(-c(month, year,day)) %>% 
  mutate(freq = round(doses / sum(doses), 3)) %>% 
  group_by(date) %>% 
  summarise(freq = mean(freq)) %>% 
  ggplot( aes(x=date, y=freq, fill = date)) +
  geom_col() +
  theme_minimal()+
  theme(text = element_text(size = 16)) +
  theme(legend.position = "none")+
  scale_y_continuous(labels = scales::percent) +
  scale_x_date(date_labels = "%B",date_breaks  ="1 month")+
  theme(axis.text.x = element_text(angle=45, hjust = 1))+
  labs(title = "Процент на поставени ваксини по месеци",
       y = "% от всички дози", x= "")
  
  figure_1
```
Не се наблюдават съществени различия по отношение на процентното съотношение на
поставените дози по месеци. 

```{r echo=FALSE}
  table_1 = doses_dates %>% 
  group_by(province) %>% 
  mutate(freq_proc = round((doses / sum(doses)*100), 3)) %>% 
  select(-c(day, date))%>% 
  flextable()
table_1
```

По отношение на местата на поставяне:
Най-висок процент от поставените ваксини са поставени в лечебни заведения за
Първична извънболнична медицинска помощ (37%), следвани от лечебни заведения за
болнична медицинска помощ с поставени близо 33% от всички дози. В категория други
(null) - в т.ч специално разкрити пунктове са поставени 13,2 % от всички дози. 

```{r echo=FALSE}
table_2 =
  doses_types %>% 
  group_by(type) %>% 
  summarise(doses= sum(doses)) %>% 
  mutate(freq_proc = round((doses / sum(doses)*100), 3)) %>% 
  flextable()
table_2
```


По отношение на разделението по области в област София - столица са потребени 
26.2 % от всички дози за страната в разглеждания период. Дори при разглеждането
на ваксинационото покритие като реализирани дози на 100 души население (което е
методологично неправилно) в софия (столица) отново се наблюдава най-високо съотношение
със средно 86.19545 дози на 100 жители. 


```{r echo=FALSE}

population_tb3 = population %>% 
  filter(year == "2022") %>% 
  select(-c(year, region_id)) %>% 
  rename(region = province)
table_3 =
  doses_types %>% 
  group_by(region) %>% 
  summarise(doses= sum(doses)) %>% 
  mutate(freq_proc = round((doses / sum(doses)*100), 3)) %>% 
  left_join(population_tb3) %>% 
  mutate(vac_rate_per_100 = (doses/population)*100)%>% 
  select(-c(population, doses)) %>% 
  flextable()
table_3
```




Има ли зависмост между области с висока заболяемсот и имунизационния обхват?
Има ли зависмост между областите с висока смъртност/леталите и имунизационния обхват?



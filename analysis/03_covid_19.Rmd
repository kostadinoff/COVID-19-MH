---
title: "Анализ на регистрираните COVID-19 случаи"
author: "Кеворкян К., Райчева Р.Костадинов К."
date: "24/03/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r pakeges, include=FALSE}
library(tidyverse)
library(easystats)
library(tayloRswift)
library(readr)
library(officer)
library(janitor)
library(flextable)
library(apyramid)
library(rstatix)
library(gtsummary)
Sys.setlocale(locale = "Bulgarian")
```



```{r read_data, include=FALSE}
cov = read_csv("C:\\\\Users\\PC\\Desktop\\covid_full.csv", 
    col_types = cols(exam_date = col_date(format = "%d.%m.%Y"), 
         lastvac_date = col_date(format = "%d.%m.%Y"), 
         start_hospis = col_date(format = "%d.%m.%Y"), 
         end_hospis = col_date(format = "%d.%m.%Y")))
cov = as_tibble(cov)
```

```{r data_prepare, include=FALSE}
cov = cov %>% 
  mutate(status = if_else(is.na(outcome_covid), "R", "D")) %>% 
  mutate(hospital_treat = ifelse(is.na(start_hospis), "Home", "Hospital")) %>% 
  mutate(wave = case_when(exam_date <='2021-07-07'~ "alpha",
                          exam_date > '2021-07-07' & exam_date <= '2022-01-26' ~ "delta",
                          exam_date > '2022-01-26'~ "omicron")) %>% 
  mutate(time_test_hospital = case_when(hospital_treat == "Hospital" ~difftime(start_hospis, exam_date, units = "days"),
                                       
                                   hospital_treat == "Home" ~ 0)) %>%
  mutate(time_in_hospital = case_when(hospital_treat == "Hospital" ~difftime(end_hospis, start_hospis, units = "days"),
                                       
                                   hospital_treat == "Home" ~ 0)) %>%
  mutate(time_test_hospital = as.numeric(time_test_hospital)) %>% 
  mutate(time_in_hospital = as.numeric(time_in_hospital)) %>% 
  mutate(vax_status = if_else(is.na(vaccine_name), "No_vax", "Vax")) %>% 
  mutate(vac_status = case_when(vax_status == "Vax" & lastvac_date < exam_date ~ "Vax",
                                TRUE ~ "No_vax")) %>% 
  dplyr::select(-vax_status) %>% 
  mutate(time_after_vax = case_when(vac_status == "Vax" ~ difftime(exam_date,lastvac_date, units = "days"),
                                       
                                   vac_status == "No_vax"  ~ 0)) %>% 
  mutate(time_after_vax = as.numeric(time_after_vax)) %>% 
  mutate(month = format(exam_date, "%m"), year = format(exam_date, "%Y")) 
```


```{r data_prepare, include=FALSE}
cov$time_to_event <- replace(cov$time_to_event, cov$time_to_event <= 0 & cov$hospital_treat == "Home" , NA)      
cov$time_to_event <- replace(cov$time_to_event, cov$time_to_event < 0, NA) 
cov$time_after_vax <- replace(cov$time_after_vax, cov$time_after_vax < 0, NA)      
cov$time_in_hospital <- replace(cov$time_in_hospital, cov$time_in_hospital <= 0, NA) 
cov["age_group"] = cut(cov$age, c(0, 14, 24,34, 44, 54, 64, 74, 84, 94, Inf), 
                       c("0-14","15-24","25-34","35-44","45-54","55-64",
                         "65-74","75-84","85-94","> 95"), include.lowest=TRUE)

```

```{r read_data, include=FALSE}
rhi = read_csv("C:\\\\Users\\PC\\Desktop\\rhi_m.csv",
    col_types = cols(date = col_date(format = "%d/%m/%Y")))
rhi = rhi %>% 
  as_tibble() %>% 
  mutate(month = format(date, "%m"), year = format(date, "%Y")) %>% 
  rename( province = region )
```

```{r read_data, include=FALSE}

rhi_due = read_csv("C:\\\\Users\\PC\\Desktop\\rhi_y.csv",
   col_types = cols(year = col_character()))
```

```{r read_data, include=FALSE}
population = read_csv("C:\\\\Users\\PC\\Desktop\\population.csv")
population = population %>% 
  rename("2022" = "av_p") %>% 
  pivot_longer(cols = 3:5, names_to = "year", values_to = "population") %>% 
  rename(province = region)
```

```{r read_data, include=FALSE}
cov_pivot = cov %>% 
  group_by(province, month, year) %>% 
  summarise(n = n())
```

```{r read_data, include=FALSE}
jt = cov_pivot %>% 
  left_join(population) %>% 
  left_join(rhi_due)
```

```{r read_data, include=FALSE}
cov  = cov %>% 
  left_join(jt)
```

```{r read_data, include=FALSE}
doses_dates <- read_csv("C:/Users/PC/Desktop/doses_dates.csv", 
     col_types = cols(date = col_datetime(format = "%d/%m/%Y %H:%M"), 
         ...3 = col_skip()))
doses_dates = doses_dates %>% 
  mutate(month = format(date, "%m"), year = format(date, "%Y")) %>% 
  rename(province = region) %>% 
  select(-date)
```

```{r read_data, include=FALSE}
doses_types <- read_csv("C:/Users/PC/Desktop/doses_types.csv")
```


```{r read_data, include=FALSE}
cov_j = cov %>% 
  group_by(province, month, year, status) %>% 
  summarise(n= n()) %>% 
  pivot_wider(names_from = status, values_from = n) %>% 
  mutate_if(is.integer, ~replace(., is.na(.), 0)) %>% 
  mutate(case_fatality = (D / (D+R)*100)) %>% 
  left_join(doses_dates) %>% 
  select(-c(R, D)) %>% 
  mutate(doses = if_else(is.na(doses), 0, doses)) %>% 
  left_join(population) %>% 
  select(-region_id) %>% 
  mutate(doses_per_capita = (doses/population)*100) %>% 
  select(-c(population, doses)) %>% 
  select(case_fatality, doses_per_capita)
```

```{r read_data, include=FALSE}
cov_j %>% 
  group_by(province) %>% 
  summarise(case_fatality = mean(case_fatality),
            doses_per_capita = mean(doses_per_capita)) %>% 
  ungroup() %>% 
  select(case_fatality, doses_per_capita) %>% 
  correlation()
```

# Общо поставени васкини (брой и вид поставени ваксини; във времето по вид ваксина; по области, по места на посатвяне на ваксината/пунтове за поставяне)

```{r read_data, include=FALSE}
doses_shots <- read_csv("C:/Users/PC/Desktop/doses_shots.csv",
         col_types = cols(...2 = col_skip())) %>% 
  pivot_longer(col = 2:12, names_to = "type", values_to = "n")

```

В предоставената информация по отношение на васинациите се установява общ брой поставени ваксини от: 4331511. 
```{r}
doses_dates$date <- zoo::as.yearmon(paste(doses_dates$year, doses_dates$month), "%Y %m")

table_1 = doses_dates %>% 
  group_by(province, date) %>% 
  summarise(vac = sum(doses)) 


  freq_table(province, date)
```







Има ли зависмост между области с висока заболяемсот и имунизационния обхват?
Има ли зависмост между областите с висока смъртност/леталите и имунизационния обхват?


